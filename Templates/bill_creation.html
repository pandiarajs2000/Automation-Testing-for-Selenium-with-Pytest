<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dynamic Product Table</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container mt-5">
    <h4 class="mb-4">Product Table</h4>
    <form method="POST">
        <table class="table table-bordered" id="productTable">
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Qty</th>
                    <th>Rate</th>
                    <th>Category</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- Empty on load -->
            </tbody>
        </table>

        <div class="row align-items-end mb-3">
            <div class="col-md-4">
                <label for="grand_total" class="form-label"><strong>Grand Total:</strong></label>
                <input type="text" id="grand_total" name="grand_total" class="form-control" readonly>
            </div>
            <div class="col-md-4 d-flex justify-content-center">
                <button class="btn btn-success w-100" onclick="addRow()" type="button">Add Row</button>
            </div>
            <div class="col-md-4 d-flex justify-content-center">
                <button class="btn btn-danger w-100" onclick="deleteSelectedRows()" type="button">Delete Selected</button>
            </div>
        </div>
        <div class="row align-items-end mb-3">
            <div class="col-md-4 d-flex justify-content-center">
                <button class="btn btn-primary w-100" onclick="saveData()" type="button">Save</button>
            </div>
        </div>
    </form>
</div>

<div class="container mt-5">
    <h5 class="mt-4">Saved Product Entries</h5>
    <table class="table table-striped" id="savedTable">
        <thead>
            <tr>
                <th>Product ID</th>
                <th>Name</th>
                <th>Qty</th>
                <th>Rate</th>
                <th>Total</th>
            </tr>
        </thead>
        <tbody id="savedDataBody"></tbody>
    </table>
</div>

<script>
    const productData = {{ product_data | tojson | safe }};
    function addRow() {
        const table = document.querySelector("#productTable tbody");
        const row = document.createElement("tr");

        row.innerHTML = `
            <td><input type="checkbox" class="row-select"></td>
            <td>
                <select class="form-select product-id" onchange="fillRowDetails(this)">
                    <option value="">-- Select --</option>
                    ${productData.map(p => `<option value="${p.product_id}">${p.product_id}</option>`).join('')}
                </select>
            </td>
            <td><input type="text" class="form-control product-name" readonly></td>
            <td><input type="number" class="form-control qty" oninput="updateTotal(this)"></td>
            <td><input type="number" class="form-control rate" oninput="updateTotal(this)"></td>
            <td><input type="text" class="form-control category" readonly></td>
            <td><input type="text" class="form-control total" readonly></td>
        `;

        table.appendChild(row);
    }

    function fillRowDetails(selectElem) {
        const selectedId = selectElem.value;
        const product = productData.find(p => p.product_id == selectedId);

        if (product) {
            const row = selectElem.closest("tr");
            row.querySelector(".product-name").value = product.product_name;
            row.querySelector(".qty").value = product.qty;
            row.querySelector(".rate").value = product.rate;
            row.querySelector(".category").value = product.category;

            // Calculate initial total
            const total = product.qty * product.rate;
            row.querySelector(".total").value = total.toFixed(2);

            updateGrandTotal();
        }
    }

    function updateTotal(elem) {
        const row = elem.closest("tr");
        const qty = parseFloat(row.querySelector(".qty").value) || 0;
        const rate = parseFloat(row.querySelector(".rate").value) || 0;
        const total = qty * rate;
        row.querySelector(".total").value = total.toFixed(2);

        updateGrandTotal();
    }

    function updateGrandTotal() {
        const totals = document.querySelectorAll(".total");
        let grandTotal = 0;

        totals.forEach(t => {
            const val = parseFloat(t.value) || 0;
            grandTotal += val;
        });

        document.getElementById("grand_total").value = grandTotal.toFixed(2);
    }
    function deleteSelectedRows() {
        const table = document.querySelector("#productTable tbody");
        const selectedCheckboxes = table.querySelectorAll(".row-select:checked");

        if (selectedCheckboxes.length === 0) {
            alert("Please select at least one row to delete.");
            return;
        }

        selectedCheckboxes.forEach(checkbox => {
            const row = checkbox.closest("tr");
            row.remove();
        });

        updateGrandTotal(); // Recalculate grand total after deletion
    }
    function saveData() {
        const tbody = document.getElementById("productTable").querySelector("tbody");
        const savedBody = document.getElementById("savedDataBody");

        tbody.querySelectorAll("tr").forEach(row => {
            const id = row.querySelector("[name='product_id']").value;
            const name = row.querySelector("[name='product_name']").value;
            const qty = row.querySelector(".qty").value;
            const rate = row.querySelector(".rate").value;
            const total = row.querySelector(".total").value;

            const savedRow = document.createElement("tr");
            savedRow.innerHTML = `<td>${id}</td><td>${name}</td><td>${qty}</td><td>${rate}</td><td>${total}</td>`;
            savedBody.appendChild(savedRow);
        });

        // Optional: clear form after saving
        tbody.innerHTML = "";
        document.getElementById("grand_total").value = "";
    }
</script>
</body>
</html>
